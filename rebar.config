%% -*- tab-width: 4;erlang-indent-level: 4;indent-tabs-mode: nil -*-
%% ex: ft=erlang ts=4 sw=4 et

{erl_opts, [debug_info,
            {platform_define, "R14", no_callback_support},
            {platform_define, "^[0-9]+", namespaced_types},
            {platform_define, "^R", no_proxy_sni_support},
            {platform_define, "^(1|(20))", no_customize_hostname_check},
            {platform_define, "^20\.3", buggy_chacha_ciphers}
           ]}.

{erl_first_files,
 ["src/hackney_ssl_certificate.erl" % required by `hackney_ssl' at compile time
 ]}.

{xref_checks, [undefined_function_calls]}.

{cover_enabled, true}.
{eunit_opts, [verbose]}.

%% QUIC NIF build hooks (only if libs/ngtcp2 exists)
%% Use HACKNEY_QUIC_OPTS for cmake options, HACKNEY_QUIC_BUILDOPTS for build options
{pre_hooks, [{clean, "rm -f priv/*.so priv/*.dll"},
             {clean, "rm -rf _build/cmake"},
             {"(linux|darwin|solaris)", compile, "./do_cmake.sh $HACKNEY_QUIC_OPTS"},
             {"(freebsd|netbsd|openbsd)", compile, "./do_cmake.sh $HACKNEY_QUIC_OPTS"},
             {"win32", compile, "if exist libs\\ngtcp2 (mkdir _build\\cmake 2>nul & cd _build\\cmake & cmake -DCMAKE_GENERATOR_PLATFORM=x64 ..\\..\\c_src)"}
            ]}.

{post_hooks, [{clean, "rm -rf *~ */*~ */*.xfm test/*.beam"},
              {"(linux|darwin|solaris)", compile, "./do_quic.sh $HACKNEY_QUIC_BUILDOPTS"},
              {"(freebsd|netbsd|openbsd)", compile, "./do_quic.sh $HACKNEY_QUIC_BUILDOPTS"},
              {"win32", compile, "if exist libs\\ngtcp2 cmake --build _build\\cmake --config Release --parallel"}
             ]}.

{deps, [
        {idna, "~>6.1.0"},
        {mimerl, "~>1.4"},
        {certifi, "~>2.15.0"},
        {metrics, "~>1.0.0"},
        {parse_trans, "3.4.1"},
        {ssl_verify_fun, "~>1.1.0"},
        {unicode_util_compat, "~>0.7.1"}
       ]}.

{profiles, [{test, [
               {deps, [{cowboy, "2.12.0"}, {jsx, "3.1.0"}]}
             ]}
           ]}.

{hex, [
       {doc, #{provider => ex_doc}}
      ]}.



{project_plugins, [rebar3_ex_doc]}.

{ex_doc, [
    {extras, [
        {"README.md", #{title => "Overview"}},
        {"GETTING_STARTED.md", #{title => "Getting Started"}},
        {"guides/http_guide.md", #{title => "HTTP Guide"}},
        {"guides/websocket_guide.md", #{title => "WebSocket Guide"}},
        {"guides/design.md", #{title => "Design Guide"}},
        {"guides/MIGRATION.md", #{title => "Migration Guide"}},
        {"NEWS.md", #{title => "Changelog"}},
        {"LICENSE", #{title => "License"}},
        {"NOTICE", #{title => "Notice"}}
    ]},
    {main, "README.md"},
    {source_url, "https://github.com/benoitc/hackney"},
    {source_ref, <<"master">>}
]}.

%% == Dialyzer ==
%%
{dialyzer, [
  {warnings, [
%   race_conditions,
    no_return,
    unmatched_returns,
    error_handling%,
    %unknown
  ]},
  {base_plt_apps, [erts, stdlib, kernel, crypto, runtime_tools]},
  {plt_apps, top_level_deps},
  {plt_extra_apps, []},
  {plt_location, local},
  {plt_prefix, "hackney"},
  {base_plt_location, "."},
  {base_plt_prefix, "hackney"}
]}.
